<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Article</title>
        <link href="css/styles.css" type="text/css" rel="stylesheet" />
        <link href="css/responsive.css" type="text/css" rel="stylesheet" />
        <link href="css/isotope.css" type="text/css" rel="stylesheet" />
        <link href="css/bootstrap.css" type="text/css" rel="stylesheet" />
        <script src="https://kit.fontawesome.com/819befa940.js" crossorigin="anonymous"></script>
    </head>

    <body>
        <div class="loading" id="preloader">
            <img src="/images/loading2.gif" alt="">
        </div>
        <div class="afterloading" id="afterload">

            <header class="nav-header">

                <div class="logo">
                    <a href="index.html" class="header__logo"><img src="./images/mine_logo.png"></a>
                </div>
                <div class="hamburger" id="nav-toggle" name="menu-outline">
                    <div class="line"></div>
                    <div class="line"></div>
                    <div class="line"></div>

                </div>
                <nav class="nav" id="nav-menu">
                    <div class="nav__content bd-grid">

                        <div class="nav__close" id="nav-close">

                            <i class="fa fa-times" aria-hidden="true"></i>
                        </div>

                        <div class="nav__perfil">
                            <div class="nav__img">
                                <img src="./images/mine_logo.png" alt="">
                            </div>


                        </div>

                        <div class="nav__menu">
                            <ul class="nav__list">
                                <li class="nav__item"><a href="index.html" class="nav__link ">Home</a></li>
                                <li class="nav__item"><a href="about.html" class="nav__link">About</a></li>
                                <li class="nav__item"><a href="experience.html" class="nav__link">Experience</a></li>
                                <li class="nav__item"><a href="contact.html" class="nav__link">Contact</a></li>
                                <li class="nav__item"><a href="blog.html" class="nav__link active">Blog</a></li>


                            </ul>
                        </div>

                        <div class="nav__login" id="nav_login">

                            <a href="login.html" class="nav__social-icon ">Login</a>


                        </div>
                        <div class="nav__logout text-white" id="nav_logout">
                            <div class="dropdown  nav__logout1 ">
                                <span id="username"></span>

                                <div class="dropdown-content text-black">
                                    <a href="./dashboard/index.html" class="text-success" id="admin_link">Dashboard</a>
                                    <a href="profile.html" class="text-success" id="profile_link">Profile</a>
                                    <a class="text-success" id="logout-link" onclick="logout()">logout</a>
                                </div>

                            </div>
                        </div>
                    </div>
                </nav>
            </header>
            <main id="main">
                <div class="header">
                    <p class="text-white text-center mt-3 fadeInUp animated"> </p>
                </div>
                <div class="content_blog card">
                    <div class="container ">
                        <div class="row  mt-4">
                            <div class="col-lg-6 fadeInUp animated">
                                <img id="blog_img" class="img-artical">


                            </div>
                            <div class="col-lg-6 text-black">
                                <div class="row">

                                    <div class="col-lg-12 fadeInUp animated mt-3">
                                        <h5 id="blog-title"></h5>
                                        <p id="blog-description"> </p>
                                    </div>
                                    <div class="col-lg-12 mt-5">
                                        <div class="row">
                                            <div class="col-md-4 text-muted fadeInUp animated">
                                                posted at <span id="blog-posted-at">


                                                </span>
                                            </div>
                                            <div class="col-sm-4">
                                                <div class="like-dislike-share fadeInUp animated ">
                                                    <a href="#" class="text-muted"><i class="fa fa-thumbs-up  "><span
                                                                class="ml-1">30</span></i></a>
                                                    <a href="#" class="text-muted"><i class="fa fa-thumbs-down  "><span
                                                                class="ml-1">6</span></i></a>
                                                    <a href="#" class="text-muted"><i class="fa fa-share  "></i></a>

                                                </div>

                                            </div>
                                            <div class="col-sm-3 text-muted fadeInUp animated">
                                                comment <span class="ml-1" id="comment_count"></span>
                                            </div>
                                        </div>
                                    </div>

                                </div>

                            </div>
                        </div>
                        <div class="row mt-5 text-black">
                            <div class="col-lg-12">
                                <h5 class="muted-text fadeInUp animated">
                                    Give A Comment on this Article
                                </h5>
                                <div class="row mb-5">
                                    <div class="col-lg-6 fadeInUp animated">
                                        <form action="" method="post" id="form_comment">
                                            <span class="text-danger" id="name-error"></span>


                                            <input type="text" name="name" class="form-control" placeholder="Full Name"
                                                id="">
                                            <span class="text-danger" id="email-error"></span>
                                            <input type="text" name="email" class="form-control  mt-3"
                                                placeholder="Email">

                                            <span class="text-danger" id="comment-error"></span>
                                            <textarea rows="4" cols="50" name="comment" class=" form-control mt-3"
                                                placeholder="Give your comment here..."></textarea>

                                            <input type='submit' value="COMMENT" class="btn btn-primary-1 mb-3 mt-3">
                                        </form>
                                    </div>
                                    <div class="col-lg-6  animated fadeInUp pb-4 ">
                                        <h4 class=" text-black-50 ">COMMENTS:</h4>
                                        <div id="blogComment">

                                        </div>



                                    </div>

                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </main>
            <footer class="footer">
                <div>
                    <ul>
                        <li>
                            <a href=" #"><i class="fa fa-twitter"></i></a>
                        </li>
                        <li>
                            <a href="#"><i class="fa fa-facebook"></i></a>
                        </li>
                        <li>
                            <a href="#"><i class="fa fa-github"></i></a>
                        </li>
                        <li>
                            <a href="#"><i class="fa fa-instagram"></i></a>
                        </li>
                    </ul>
                </div>
                <form id="subscription-form">
                    <div style="display: flex;">
                        <input type="text" name="email" class="form-control" id="email"
                            placeholder="Subscriber to My blog">
                        &nbsp;
                        <span>
                        </span>
                        <button type="submit" style="background-color: currentColor; border: none;"> <i
                                class="fa fa-rocket" style="font-size:30px; cursor: pointer; color:red;"
                                aria-hidden=" true"></i></button>


                    </div>
                </form>
                <div>copyright <i class="fa fa-copyright " aria-hidden="true"> </i>2022 Fabrice All Rights Reserved
                </div>

            </footer>
        </div>
        <script src="./js/app.js"></script>
        <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

        <script>
            window.onload = setTimeout( function () {

                const preloader = document.getElementById( "preloader" );
                preloader.style.opacity = 0.1;
                const afterload = document.getElementById( "afterload" );
                preloader.style.display = "none";
                afterload.style.display = "block";
            }, 2000 );
            const contactform = document.querySelector( "#form_comment" );
            var BlogId = location.search.substring( 1 );
            async function UserInformation() {

                const userInfos = await fetch( api + "userInfo", {
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': token
                    }
                } );
                const userInfo = await userInfos.json();
                if ( userInfos.status == 200 ) {
                    contactform.name.value = userInfo.data.firstname + ' ' + userInfo.data.lastname;
                    contactform.name.readOnly = true;
                    contactform.email.value = userInfo.data.email;
                    contactform.email.readOnly = true;
                }
                else if ( userInfos.status == 404 ) {
                    contactform.email.readOnly = false;
                    contactform.name.readOnly = false;

                }
                else {

                    console.log( "Internet problem" );
                }
            }
            const blog_img = document.getElementById( 'blog_img' );
            const blog_title = document.getElementById( 'blog-title' );
            const blog_description = document.getElementById( 'blog-description' );
            const blog_created_at = document.getElementById( 'blog-posted-at' );
            const comment_count = document.getElementById( "comment_count" );

            async function Blog() {

                try {
                    response = await fetch( api + 'blog/' + BlogId );
                    const datas = await response.json();

                    blog_img.setAttribute( 'src', datas.data.ArticleImage );
                    blog_title.innerHTML = datas.data.ArticleTitle;
                    blog_description.textContent = datas.data.ArticleDescription;
                    const date = datas.data.created_at;

                    blog_created_at.innerHTML = new Date( date ).toDateString();
                    comment_count.innerHTML = datas.data.comments.length;
                    const DataId = datas.data._id;


                }
                catch ( error ) {
                    console.log( error );
                };

            };
            async function getAllMessage() {


                response = await fetch( api + "blog/" + BlogId + "/comment" );
                const commentData = await response.json();
                commentData.data.forEach( comment => {

                    const single_comment = comment.comment;
                    const single_email = comment.email;
                    const single_name = comment.fullname;
                    const single_date = comment.created_at;
                    SingleBlog( single_name, single_comment, single_date );

                } );

                function SingleBlog( single_name, single_comment, single_date ) {
                    const blogComments = document.getElementById( "blogComment" );

                    const date_post = new Date( single_date ).toDateString();
                    const spanData = document.createElement( 'span' );
                    const blogComment = `<hr class="two-line">
                        <hr class="two-line pb-1">
                        <h6 class="text-muted text-sm ">${single_name} on  ${date_post}
                            <span>said:</span>
                            </h6>
                            <p class="text-muted text-sm"> ${single_comment}
                                </p> `;
                    spanData.innerHTML = blogComment;

                    blogComments.appendChild( spanData );

                }


            }
            contactform.addEventListener( 'submit', async ( e ) => {
                e.preventDefault();
                var name = contactform.name.value;
                var email = contactform.email.value;
                var comment = contactform.comment.value;

                try {
                    response = await fetch( api + "blog/" + BlogId + "/comment", {
                        method: "POST",
                        headers: {
                            "Authorization": token,
                            'Accept': 'application/json',
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify( {
                            fullname: name,
                            email: email,
                            comment: comment
                        } )
                    } );
                    const commentMessage = await response.json();

                    if ( response.status == 403 ) {
                        swal( "Error", commentMessage.message, "error" ).then( () => {

                            contactform.name.value = "";
                            contactform.email.value = "";
                            contactform.comment.value = "";

                        } );
                    }
                    else if ( response.status == 400 ) {
                        swal( "Error", commentMessage.error, "error" ).then( () => {
                            contactform.name.value = "";
                            contactform.email.value = "";
                            contactform.comment.value = "";
                            localStorage.removeItem( "token" );
                            localStorage.removeItem( "username" );
                            localStorage.removeItem( "role" );
                            localStorage.removeItem( "userId" );
                            location.href = "login.html";
                        } );
                    }
                    else if ( response.status == 409 ) {
                        swal( "Error", commentMessage.error, 'error' ).then( () => {
                            contactform.comment.value = "";
                            location.reload();
                        } );
                    }
                    else {
                        swal( "Success", commentMessage.message, "success" ).then( () => {
                            contactform.comment.value = "";
                            location.reload();
                        } );
                    }
                }
                catch ( error ) {
                    swal( 'error ', error, 'error' );

                };


                // } );
            } );
            getAllMessage();
            UserInformation();
            Blog()
        </script>
    </body>

</html>
