<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Article</title>
    <link href="css/styles.css" type="text/css" rel="stylesheet" />
    <link href="css/responsive.css" type="text/css" rel="stylesheet" />
    <link href="css/isotope.css" type="text/css" rel="stylesheet" />
    <link href="css/bootstrap.css" type="text/css" rel="stylesheet" />
    <script src="https://kit.fontawesome.com/819befa940.js" crossorigin="anonymous"></script>
</head>

<body>
    <header class="nav-header">

        <div class="logo">
            <a href="index.html" class="header__logo"><img src="./images/mine_logo.png"></a>
        </div>
        <div class="hamburger" id="nav-toggle" name="menu-outline">
            <div class="line"></div>
            <div class="line"></div>
            <div class="line"></div>

        </div>
        <nav class="nav" id="nav-menu">
            <div class="nav__content bd-grid">

                <div class="nav__close" id="nav-close">

                    <i class="fa fa-times" aria-hidden="true"></i>
                </div>

                <div class="nav__perfil">
                    <div class="nav__img">
                        <img src="./images/mine_logo.png" alt="">
                    </div>


                </div>

                <div class="nav__menu">
                    <ul class="nav__list">
                        <li class="nav__item"><a href="index.html" class="nav__link ">Home</a></li>
                        <li class="nav__item"><a href="about.html" class="nav__link">About</a></li>
                        <li class="nav__item"><a href="experience.html" class="nav__link">Experience</a></li>
                        <li class="nav__item"><a href="contact.html" class="nav__link">Contact</a></li>
                        <li class="nav__item"><a href="blog.html" class="nav__link active">Blog</a></li>


                    </ul>
                </div>

                <div class="nav__login" id="nav_login">

                    <a href="login.html" class="nav__social-icon ">Login</a>


                </div>
                <div class="nav__logout text-white" id="nav_logout">
                    <div class="dropdown  nav__logout1 ">
                        <span id="username"></span>

                        <div class="dropdown-content text-black">
                            <a href="./dashboard/index.html" class="text-success" id="admin_link">Dashboard</a>
                            <a class="text-success" id="logout-link" onclick="logout()">logout</a>
                        </div>

                    </div>
                </div>
            </div>
        </nav>
    </header>
    <main id="main">
        <div class="header">
            <p class="text-white text-center mt-3 fadeInUp animated"> </p>
        </div>
        <div class="content_blog card">
            <div class="container ">
                <div class="row  mt-4">
                    <div class="col-lg-6 fadeInUp animated">
                        <img id="blog_img" class="img-artical">


                    </div>
                    <div class="col-lg-6 text-black">
                        <div class="row">

                            <div class="col-lg-12 fadeInUp animated mt-3">
                                <h5 id="blog-title"></h5>
                                <p id="blog-description"> </p>
                            </div>
                            <div class="col-lg-12 mt-5">
                                <div class="row">
                                    <div class="col-md-4 text-muted fadeInUp animated">
                                        posted at <span id="blog-posted-at">

                                            
                                        </span>
                                    </div>
                                    <div class="col-sm-4">
                                        <div class="like-dislike-share fadeInUp animated ">
                                            <a href="#" class="text-muted"><i class="fa fa-thumbs-up  "><span
                                                        class="ml-1">30</span></i></a>
                                            <a href="#" class="text-muted"><i class="fa fa-thumbs-down  "><span
                                                        class="ml-1">6</span></i></a>
                                            <a href="#" class="text-muted"><i class="fa fa-share  "></i></a>

                                        </div>

                                    </div>
                                    <div class="col-sm-3 text-muted fadeInUp animated">
                                        comment <span class="ml-1">23</span>
                                    </div>
                                </div>
                            </div>

                        </div>

                    </div>
                </div>
                <div class="row mt-5 text-black">
                    <div class="col-lg-12">
                        <h5 class="muted-text fadeInUp animated">
                            Give A Comment on this Article
                        </h5>
                        <div class="row mb-5">
                            <div class="col-lg-6 fadeInUp animated">
                                <form action="" method="post" id="form_comment">
                                    <span class="text-danger" id="name-error"></span>


                                    <input type="text" name="name" class="form-control" placeholder="Full Name" id="">
                                    <span class="text-danger" id="email-error"></span>
                                    <input type="text" name="email" class="form-control  mt-3" placeholder="Email">

                                    <span class="text-danger" id="comment-error"></span>
                                    <textarea rows="4" cols="50" name="comment" class=" form-control mt-3"
                                        placeholder="Give your comment here..."></textarea>

                                    <input type='submit' value="COMMENT" class="btn btn-primary-1 mb-3 mt-3">
                                </form>
                            </div>
                            <div class="col-lg-6  animated fadeInUp pb-4 ">
                                <h4 class=" text-black-50 ">COMMENTS:</h4>
                                <div id="blogComment">

                                </div>



                            </div>

                        </div>

                    </div>
                </div>
            </div>
        </div>
    </main>
    <footer class="footer">
        <div>
            <ul>
                <li>
                    <a href="#"><i class="fa fa-twitter"></i></a>
                </li>
                <li>
                    <a href="#"><i class="fa fa-facebook"></i></a>
                </li>
                <li>
                    <a href="#"><i class="fa fa-github"></i></a>
                </li>
                <li>
                    <a href="#"><i class="fa fa-instagram"></i></a>
                </li>
            </ul>
        </div>
        <div>copyright <i class="fa fa-copyright" aria-hidden="true"> </i>2022 Fabrice. All Rights Reserved</div>
        <div>Designed by NDACYAYISENGA Fabrice</div>
    </footer>
    <script src="https://www.gstatic.com/firebasejs/7.19.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.19.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.19.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.19.1/firebase-storage.js"></script>
    <script src="./js/app.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

    <script>
        const contactform = document.querySelector("#form_comment");
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                var uid = user.uid;

                db1
                    .collection("users")
                    .doc(uid)
                    .get()
                    .then((docRef) => {
                        const data = docRef.data();
                        contactform.name.value = data.FirstName + ' ' + data.LastName;
                        contactform.name.readOnly = true;
                        contactform.email.value = user.email;
                        contactform.email.readOnly = true;
                    });
            }
            else {
                contactform.email.readOnly = false;
                contactform.name.readOnly = false;
            }
        })
        window.onload = (e) => {
            e.preventDefault();
            const blog_img = document.getElementById('blog_img');
            const blog_title = document.getElementById('blog-title');
            const blog_description = document.getElementById('blog-description');
            const blog_created_at = document.getElementById('blog-posted-at');

            var queryString = location.search.substring(1);
            let blogId;

            const db = app.firestore();
            var blogRef = db

                .collection("blogs")
                .doc(queryString)
                .get()
                .then((docRef) => {
                    const Datas = docRef.data();
                    blog_img.setAttribute('src', Datas.imageURL);
                    blog_title.innerHTML = Datas.title;
                    blog_description.textContent = Datas.description;
                    const date = Datas.date;
                    
                    blog_created_at.innerHTML =date.toDate().toDateString();
                    const DataId = docRef.id;
                    blogId = DataId;

                })
                .catch((error) => {

                })
            var blog_comments = db.collection('comments').where("blog_id", "==", queryString)
                .get().then((comments) => {
                    comments.forEach(comment => {
                        const datas = comment.data();
                        const single_comment = datas.comment;
                        const single_email = datas.email;
                        const single_name = datas.name;
                        const single_date = datas.date;
                        SingleBlog(single_name, single_comment, single_date);

                    });
                });
            function SingleBlog(single_name, single_comment, single_date) {
                const blogComments = document.getElementById("blogComment");

                const date_post = (single_date).toDate().toDateString();
                const spanData = document.createElement('span');
                const blogComment = `<hr class="two-line">
                                <hr class="two-line pb-1">
                                <h6 class="text-muted text-sm ">${single_name} on  ${date_post}
                                    <span>said:</span>
                                </h6>
                                <p class="text-muted text-sm"> ${single_comment}
                                </p> `;
                spanData.innerHTML = blogComment;

                blogComments.appendChild(spanData);

            }


            contactform.addEventListener('submit', (e) => {
                e.preventDefault();
                var name = contactform.name.value;
                var email = contactform.email.value;
                var comment = contactform.comment.value;
                if (contactform.email.value == "" || contactform.email.value == null) {
                    document.getElementById('email-error').innerHTML = "Email is required";
                    contactform.email.classList.add('is-invalid');
                    contactform.email.focus();

                    return false;
                }
                else {
                    contactform.email.classList.remove('is-invalid');
                    document.getElementById('email-error').innerHTML = "";

                    contactform.email.classList.add('is-valid');

                }
                var emailID = contactform.email.value;
                atpos = emailID.indexOf("@");
                dotpos = emailID.lastIndexOf(".");

                if (atpos < 1 || (dotpos - atpos < 2)) {
                    document.getElementById('email-error').innerHTML = "Check your Email again!";
                    contactform.email.classList.add('is-invalid');
                    contactform.email.focus();
                    return false;
                }
                else {
                    contactform.email.classList.remove('is-invalid');
                    document.getElementById('email-error').innerHTML = "";

                }
                if ((contactform.name.value == "" || contactform.name.value == null)) {

                    document.getElementById('name-error').innerHTML = "Name is required";
                    contactform.name.classList.add('is-invalid');
                    contactform.name.focus();

                    return false;
                }
                else {
                    contactform.name.classList.remove('is-invalid');
                    document.getElementById('name-error').innerHTML = "";

                    contactform.email.classList.add('is-valid');

                }
                if ((contactform.comment.valuee == "" || contactform.comment.value == null || contactform.comment.value.length <= 5)) {

                    document.getElementById('comment-error').innerHTML = "Your commentis less";
                    contactform.comment.classList.add('is-invalid');
                    contactform.comment.focus();

                    return false;
                }
                else {
                    contactform.comment.classList.remove('is-invalid');
                    document.getElementById('comment-error').innerHTML = "";

                    contactform.comment.classList.add('is-valid');

                }

                const blog_c = db.collection("comments").add({
                    name: name,
                    email: email,
                    comment: comment,
                    date: new Date(),
                    blog_id: queryString,
                })
                    .then((docRef) => {
                        swal('Thank You', 'Your Comment was Recieved', 'success').then(() => {
                            firebase.auth().onAuthStateChanged((user) => {
                                if (user) {
                                    var uid = user.uid;

                                    db1
                                        .collection("users")
                                        .doc(uid)
                                        .get()
                                        .then((docRef) => {
                                            const data = docRef.data();
                                            contactform.name.value = data.FirstName + ' ' + data.LastName;
                                            contactform.name.readOnly = true;
                                            contactform.email.value = user.email;
                                            contactform.email.readOnly = true;
                                            contactform.comment.value = "";

                                            contactform.comment.classList.remove('is-valid');
                                            contactform.name.classList.remove('is-valid');
                                            contactform.email.classList.remove('is-valid');
                                            location.reload();
                                        });
                                }
                                else {
                                    contactform.name.value = "";
                                    contactform.email.value = "";
                                    contactform.comment.value = "";
                                    contactform.comment.classList.remove('is-valid');
                                    contactform.name.classList.remove('is-valid');
                                    contactform.email.classList.remove('is-valid');
                                    contactform.email.readOnly = false;
                                    contactform.name.readOnly = false;
                                }
                            });
                        });

                    })
                    .catch((error) => {
                        swal('error ', docRef.name + 'error', 'error');

                    });


            });
        };
    </script>
</body>

</html>